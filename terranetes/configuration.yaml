apiVersion: terraform.appvia.io/v1alpha1
kind: Configuration
metadata:
  name: idp-module
spec:
  # Inline Terraform module code
  module: |
    resource "azurerm_resource_group" "main" {
      name     = var.resource_group_name
      location = var.location
      
      tags = {
        Environment = var.environment
        Project     = var.project_name
      }
    }

    resource "github_repository" "main" {
      name        = var.github_repo_name
      description = var.github_repo_description
      visibility  = var.github_repo_visibility
      auto_init   = true

      has_issues      = true
      has_projects    = false
      has_wiki        = false
      has_downloads   = true
      has_discussions = false
    }

    variable "resource_group_name" {
      type = string
      description = "Name of the Azure Resource Group"
    }
    
    variable "location" {
      type = string
      description = "Azure region for the Resource Group"
    }
    
    variable "environment" {
      type = string
      description = "Environment tag for resources"
    }
    
    variable "project_name" {
      type = string
      description = "Project name for tagging and naming resources"
    }
    
    variable "github_repo_name" {
      type = string
      description = "Name of the GitHub repository"
    }
    
    variable "github_repo_description" {
      type = string
      description = "Description of the GitHub repository"
    }
    
    variable "github_repo_visibility" {
      type = string
      description = "Visibility of the GitHub repository"
    }

  providerRef:
    name: azure

  # Inject GitHub credentials as environment variables
  # NOTE: This secret MUST be in the SAME namespace as this Configuration (default)
  valueFrom:
    - secret: github-credentials
      name: GITHUB_TOKEN
      key: GITHUB_TOKEN