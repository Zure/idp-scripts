apiVersion: terraform.appvia.io/v1alpha1
kind: Configuration
metadata:
  name: idp-module
spec:
  # Inline module definition
  # Alternative: use module: https://github.com/geertvdc/idp-infrastructure.git
  module: |
    terraform {
      required_version = ">= 1.0"
      
      required_providers {
        azurerm = {
          source  = "hashicorp/azurerm"
          version = "~> 4.0"
        }
        github = {
          source  = "integrations/github"
          version = "~> 6.0"
        }
      }
    }

    provider "azurerm" {
      features {}
    }

    provider "github" {
      # Credentials provided via environment variables from secrets
    }

    variable "resource_group_name" {
      description = "Name of the Azure Resource Group"
      type        = string
      default     = "rg-idp-dev"
    }

    variable "location" {
      description = "Azure region for the Resource Group"
      type        = string
      default     = "West Europe"
    }

    variable "environment" {
      description = "Environment tag for resources"
      type        = string
      default     = "dev"
    }

    variable "project_name" {
      description = "Project name for tagging and naming resources"
      type        = string
      default     = "identity-platform"
    }

    variable "github_repo_name" {
      description = "Name of the GitHub repository"
      type        = string
      default     = "idp-infrastructure"
    }

    variable "github_repo_description" {
      description = "Description of the GitHub repository"
      type        = string
      default     = "Identity Platform Infrastructure and Configuration"
    }

    variable "github_repo_visibility" {
      description = "Visibility of the GitHub repository"
      type        = string
      default     = "private"
    }

    resource "azurerm_resource_group" "main" {
      name     = var.resource_group_name
      location = var.location

      tags = {
        Environment = var.environment
        Project     = var.project_name
        ManagedBy   = "Terranetes"
      }
    }

    resource "github_repository" "main" {
      name        = var.github_repo_name
      description = var.github_repo_description
      visibility  = var.github_repo_visibility
      auto_init   = true

      has_issues      = true
      has_projects    = false
      has_wiki        = false
      has_downloads   = true
      has_discussions = false
    }

    output "resource_group_id" {
      description = "The ID of the Resource Group"
      value       = azurerm_resource_group.main.id
    }

    output "resource_group_name" {
      description = "The name of the Resource Group"
      value       = azurerm_resource_group.main.name
    }

    output "github_repo_url" {
      description = "The URL of the GitHub repository"
      value       = github_repository.main.html_url
    }

    output "github_repo_ssh_url" {
      description = "The SSH URL of the GitHub repository"
      value       = github_repository.main.ssh_clone_url
    }

  # Provider references
  providerRef:
    name: azurerm

  # Authentication secrets
  auth:
    - secret:
        name: azure-credentials
    - secret:
        name: github-credentials
